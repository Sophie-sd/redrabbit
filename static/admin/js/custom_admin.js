// Custom Admin JavaScript –¥–ª—è Beauty Shop
// –ü–æ–∫—Ä–∞—â—É—î UX, –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É—î —Ä—É—Ç–∏–Ω–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó

(function() {
    'use strict';
    
    // ============================================
    // UTILITY –§–£–ù–ö–¶–Ü–á
    // ============================================
    
    const BeautyShopAdmin = {
        // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        showMessage(text, type = 'success') {
            const message = document.createElement('div');
            message.className = `admin-flash-message admin-flash-${type}`;
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#48bb78' : '#f56565'};
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                z-index: 99999;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease;
                max-width: 400px;
            `;
            message.textContent = text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.opacity = '0';
                message.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(message), 300);
            }, 3000);
        },
        
        // –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –≤ –±—É—Ñ–µ—Ä
        copyToClipboard(text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showMessage('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É!');
                });
            } else {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                this.showMessage('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É!');
            }
        },
        
        // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –¥—ñ—ó
        confirm(message, callback) {
            if (window.confirm(message)) {
                callback();
            }
        }
    };
    
    // –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É –æ–±–ª–∞—Å—Ç—å
    window.BeautyShopAdmin = BeautyShopAdmin;
    
    // ============================================
    // DOCUMENT READY
    // ============================================
    
    document.addEventListener('DOMContentLoaded', function() {
        
        // ========== –§–û–†–ú–ò ==========
        
        // –ü–æ–∫—Ä–∞—â—É—î–º–æ UX –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ —Ñ–æ—Ä–º
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const submitBtn = form.querySelector('input[type="submit"]');
                if (submitBtn && !submitBtn.dataset.submitting) {
                    submitBtn.dataset.submitting = 'true';
                    submitBtn.disabled = true;
                    const originalValue = submitBtn.value;
                    submitBtn.value = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
                    
                    // –Ø–∫—â–æ —Ñ–æ—Ä–º–∞ –Ω–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç—å—Å—è –∑–∞ 10 —Å–µ–∫—É–Ω–¥, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–Ω–æ–ø–∫—É
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.value = originalValue;
                        delete submitBtn.dataset.submitting;
                    }, 10000);
                }
            });
        });
        
        // ========== SLUG –ê–í–¢–û–ó–ê–ü–û–í–ù–ï–ù–ù–Ø ==========
        
        const titleField = document.querySelector('#id_title, #id_name');
        const slugField = document.querySelector('#id_slug');
        
        if (titleField && slugField) {
            titleField.addEventListener('input', function() {
                // –ì–µ–Ω–µ—Ä—É—î–º–æ slug —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –ø–æ–ª–µ –ø–æ—Ä–æ–∂–Ω—î
                if (!slugField.value || slugField.dataset.autoGenerated) {
                    let slug = this.value
                        .toLowerCase()
                        .replace(/[^a-z0-9–∞-—è—î—ñ—ó\s-]/g, '')
                        .replace(/\s+/g, '-')
                        .replace(/-+/g, '-')
                        .trim();
                    
                    // –¢—Ä–∞–Ω—Å–ª—ñ—Ç–µ—Ä–∞—Ü—ñ—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤
                    const ukrainianToLatin = {
                        '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'h', '“ë': 'g',
                        '–¥': 'd', '–µ': 'e', '—î': 'ye', '–∂': 'zh', '–∑': 'z',
                        '–∏': 'y', '—ñ': 'i', '—ó': 'yi', '–π': 'y', '–∫': 'k',
                        '–ª': 'l', '–º': 'm', '–Ω': 'n', '–æ': 'o', '–ø': 'p',
                        '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u', '—Ñ': 'f',
                        '—Ö': 'kh', '—Ü': 'ts', '—á': 'ch', '—à': 'sh', '—â': 'shch',
                        '—é': 'yu', '—è': 'ya', '—å': '', '—ä': ''
                    };
                    
                    for (let [uk, lat] of Object.entries(ukrainianToLatin)) {
                        slug = slug.replace(new RegExp(uk, 'g'), lat);
                    }
                    
                    slugField.value = slug.substring(0, 50);
                    slugField.dataset.autoGenerated = 'true';
                }
            });
            
            // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—Ä—É—á–Ω—É —Ä–µ–¥–∞–≥—É—î slug, –≤–∏–º–∏–∫–∞—î–º–æ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü—ñ—é
            slugField.addEventListener('input', function() {
                if (this.value !== '') {
                    delete this.dataset.autoGenerated;
                }
            });
        }
        
        // ========== –ü–†–ï–í–¨–Æ –ó–û–ë–†–ê–ñ–ï–ù–¨ ==========
        
        const imageInputs = document.querySelectorAll('input[type="file"][accept*="image"]');
        imageInputs.forEach(input => {
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // –°—Ç–≤–æ—Ä—é—î–º–æ –∞–±–æ –æ–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–µ–≤—å—é
                        let preview = input.parentElement.querySelector('.image-preview');
                        if (!preview) {
                            preview = document.createElement('div');
                            preview.className = 'image-preview';
                            preview.style.cssText = `
                                margin-top: 15px;
                                border: 2px dashed #e2e8f0;
                                border-radius: 8px;
                                padding: 15px;
                                text-align: center;
                                background: #f7fafc;
                            `;
                            input.parentElement.appendChild(preview);
                        }
                        
                        preview.innerHTML = `
                            <img src="${e.target.result}" 
                                 style="max-width: 300px; max-height: 300px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <p style="margin: 10px 0 0 0; font-size: 13px; color: #718096;">
                                ${file.name} (${(file.size / 1024).toFixed(1)} KB)
                            </p>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
        
        // ========== –ü–Ü–î–¢–í–ï–†–î–ñ–ï–ù–ù–Ø –í–ò–î–ê–õ–ï–ù–ù–Ø ==========
        
        const deleteLinks = document.querySelectorAll('a[href*="delete"]');
        deleteLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –µ–ª–µ–º–µ–Ω—Ç? –¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏.')) {
                    e.preventDefault();
                }
            });
        });
        
        // ========== –ü–û–ö–†–ê–©–ï–ù–ù–Ø –¢–ê–ë–õ–ò–¶–¨ ==========
        
        const resultTable = document.querySelector('#result_list');
        if (resultTable) {
            // –î–æ–¥–∞—î–º–æ hover –µ—Ñ–µ–∫—Ç –¥–ª—è —Ä—è–¥–∫—ñ–≤
            const rows = resultTable.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
                // –î–æ–¥–∞—î–º–æ data-–∞—Ç—Ä–∏–±—É—Ç –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—É
                row.dataset.index = index;
                
                // –ö–ª—ñ–∫ –ø–æ —Ä—è–¥–∫—É (–∫—Ä—ñ–º —á–µ–∫–±–æ–∫—Å—ñ–≤ —Ç–∞ –ø–æ—Å–∏–ª–∞–Ω—å) –≤—ñ–¥–∫—Ä–∏–≤–∞—î —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
                row.addEventListener('click', function(e) {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'A' && !e.target.closest('a')) {
                        const editLink = this.querySelector('th a, td a');
                        if (editLink) {
                            window.location.href = editLink.href;
                        }
                    }
                });
                
                // Hover –µ—Ñ–µ–∫—Ç
                row.addEventListener('mouseenter', function() {
                    this.style.cursor = 'pointer';
                });
            });
            
            // –ü–æ–∫—Ä–∞—â—É—î–º–æ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è - –¥–æ–¥–∞—î–º–æ –≤—ñ–∑—É–∞–ª—å–Ω–∏–π feedback
            const headers = resultTable.querySelectorAll('thead th a');
            headers.forEach(header => {
                header.addEventListener('click', function() {
                    const loader = document.createElement('div');
                    loader.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.8);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 8px;
                        z-index: 99999;
                        font-size: 14px;
                    `;
                    loader.textContent = '‚è≥ –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è...';
                    document.body.appendChild(loader);
                });
            });
        }
        
        // ========== –§–Ü–õ–¨–¢–†–ò - –ü–û–ö–†–ê–©–ï–ù–ù–Ø UX ==========
        
        const filterSidebar = document.querySelector('#changelist-filter');
        if (filterSidebar) {
            const filterLinks = filterSidebar.querySelectorAll('a');
            filterLinks.forEach(link => {
                link.addEventListener('click', function() {
                    // –î–æ–¥–∞—î–º–æ –ª–æ–∞–¥–µ—Ä
                    const loader = document.createElement('div');
                    loader.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: rgba(0,0,0,0.8);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 8px;
                        z-index: 99999;
                        font-size: 14px;
                    `;
                    loader.textContent = 'üîç –§—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è...';
                    document.body.appendChild(loader);
                });
            });
        }
        
        // ========== –ú–ê–°–û–í–Ü –î–Ü–á - –ü–û–ö–†–ê–©–ï–ù–ù–Ø ==========
        
        const actionSelect = document.querySelector('select[name="action"]');
        if (actionSelect) {
            actionSelect.addEventListener('change', function() {
                const selectedAction = this.options[this.selectedIndex].text;
                if (selectedAction && selectedAction !== '---------') {
                    const checkedCount = document.querySelectorAll('input[name="_selected_action"]:checked').length;
                    if (checkedCount === 0) {
                        BeautyShopAdmin.showMessage('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –µ–ª–µ–º–µ–Ω—Ç', 'error');
                        this.value = '';
                    }
                }
            });
        }
        
        // ========== CKEDITOR –ü–û–ö–†–ê–©–ï–ù–ù–Ø ==========
        
        if (typeof CKEDITOR !== 'undefined') {
            CKEDITOR.on('instanceReady', function(event) {
                const editor = event.editor;
                
                // –î–æ–¥–∞—î–º–æ –∫–∞—Å—Ç–æ–º–Ω—ñ —Å—Ç–∏–ª—ñ
                if (document.querySelector('[href*="ckeditor-custom.css"]')) {
                    editor.addContentsCss('/static/css/ckeditor-custom.css');
                }
                
                // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ localStorage (draft)
                let autoSaveTimer;
                const formId = editor.element.$.form?.id || 'editor';
                const draftKey = `admin_draft_${formId}_${editor.name}`;
                
                // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ draft –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
                const savedDraft = localStorage.getItem(draftKey);
                if (savedDraft && !editor.getData()) {
                    if (confirm('–ó–Ω–∞–π–¥–µ–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–∏–π —á–µ—Ä–Ω–µ—Ç–∫–∞. –í—ñ–¥–Ω–æ–≤–∏—Ç–∏?')) {
                        editor.setData(savedDraft);
                    } else {
                        localStorage.removeItem(draftKey);
                    }
                }
                
                // –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
                editor.on('change', function() {
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(function() {
                        localStorage.setItem(draftKey, editor.getData());
                        console.log('Draft auto-saved');
                    }, 30000);
                });
                
                // –û—á–∏—â—É—î–º–æ draft –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                const form = editor.element.$.form;
                if (form) {
                    form.addEventListener('submit', function() {
                        localStorage.removeItem(draftKey);
                    });
                }
            });
        }
        
        // ========== –ü–ê–ì–Ü–ù–ê–¶–Ü–Ø - –ü–û–ö–†–ê–©–ï–ù–ù–Ø ==========
        
        const paginationLinks = document.querySelectorAll('.paginator a');
        paginationLinks.forEach(link => {
            link.addEventListener('click', function() {
                // Scroll to top –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
        
        // ========== –®–í–ò–î–ö–Ü –ö–õ–ê–í–Ü–®–Ü ==========
        
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S = –∑–±–µ—Ä–µ–≥—Ç–∏ —Ñ–æ—Ä–º—É
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                const submitBtn = document.querySelector('input[type="submit"][name="_save"]');
                if (submitBtn) {
                    submitBtn.click();
                    BeautyShopAdmin.showMessage('–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...');
                }
            }
            
            // Ctrl/Cmd + Shift + S = –∑–±–µ—Ä–µ–≥—Ç–∏ —ñ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 's') {
                e.preventDefault();
                const submitBtn = document.querySelector('input[type="submit"][name="_continue"]');
                if (submitBtn) {
                    submitBtn.click();
                    BeautyShopAdmin.showMessage('–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–∞ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è...');
                }
            }
        });
        
        // ========== –¶–Ü–ù–ò - –í–ê–õ–Ü–î–ê–¶–Ü–Ø ==========
        
        const priceFields = document.querySelectorAll('input[type="number"][id*="price"]');
        priceFields.forEach(field => {
            field.addEventListener('blur', function() {
                if (this.value && parseFloat(this.value) < 0) {
                    this.style.borderColor = '#f56565';
                    BeautyShopAdmin.showMessage('–¶—ñ–Ω–∞ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –≤—ñ–¥\'—î–º–Ω–æ—é', 'error');
                    this.value = '';
                } else {
                    this.style.borderColor = '';
                }
            });
        });
        
        // ========== –ê–ö–¶–Ü–ô–ù–Ü –¶–Ü–ù–ò - –ê–í–¢–û–ü–ï–†–ï–í–Ü–†–ö–ê ==========
        
        const retailPriceField = document.querySelector('#id_retail_price');
        const salePriceField = document.querySelector('#id_sale_price');
        
        if (retailPriceField && salePriceField) {
            salePriceField.addEventListener('blur', function() {
                const retail = parseFloat(retailPriceField.value);
                const sale = parseFloat(this.value);
                
                if (retail && sale && sale >= retail) {
                    this.style.borderColor = '#f56565';
                    BeautyShopAdmin.showMessage('–ê–∫—Ü—ñ–π–Ω–∞ —Ü—ñ–Ω–∞ –ø–æ–≤–∏–Ω–Ω–∞ –±—É—Ç–∏ –º–µ–Ω—à–æ—é –∑–∞ —Ä–æ–∑–¥—Ä—ñ–±–Ω—É', 'error');
                } else if (retail && sale) {
                    this.style.borderColor = '#48bb78';
                    const discount = Math.round(((retail - sale) / retail) * 100);
                    BeautyShopAdmin.showMessage(`–ó–Ω–∏–∂–∫–∞: ${discount}%`, 'success');
                }
            });
        }
        
        // ========== –¢–ê–ô–ú–ï–†–ò –î–õ–Ø –ê–ö–¶–Ü–ô ==========
        
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –∞–∫—Ü—ñ—ó
        const updateTimers = () => {
            const timerElements = document.querySelectorAll('[data-sale-end]');
            timerElements.forEach(el => {
                const endDate = new Date(el.dataset.saleEnd);
                const now = new Date();
                const diff = endDate - now;
                
                if (diff > 0) {
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    if (days <= 3) {
                        el.style.color = '#f56565';
                        el.style.fontWeight = '700';
                    }
                }
            });
        };
        
        updateTimers();
        setInterval(updateTimers, 60000); // –û–Ω–æ–≤–ª—é—î–º–æ –∫–æ–∂–Ω—É —Ö–≤–∏–ª–∏–Ω—É
        
        // ========== –ö–û–ú–ü–ê–ö–¢–ù–ò–ô –†–ï–ñ–ò–ú (EXPERIMENTAL) ==========
        
        // –î–æ–¥–∞—î–º–æ –ø–µ—Ä–µ–º–∏–∫–∞—á –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É
        const createCompactToggle = () => {
            const header = document.querySelector('#header');
            if (header && !document.querySelector('#compact-toggle')) {
                const toggle = document.createElement('button');
                toggle.id = 'compact-toggle';
                toggle.textContent = '–ö–æ–º–ø–∞–∫—Ç–Ω–∏–π –≤–∏–≥–ª—è–¥';
                toggle.style.cssText = `
                    position: absolute;
                    right: 100px;
                    top: 15px;
                    background: rgba(255,255,255,0.2);
                    color: white;
                    border: 1px solid rgba(255,255,255,0.3);
                    padding: 6px 12px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                `;
                
                toggle.addEventListener('click', function() {
                    document.body.classList.toggle('compact-mode');
                    const isCompact = document.body.classList.contains('compact-mode');
                    this.textContent = isCompact ? '–ó–≤–∏—á–∞–π–Ω–∏–π –≤–∏–≥–ª—è–¥' : '–ö–æ–º–ø–∞–∫—Ç–Ω–∏–π –≤–∏–≥–ª—è–¥';
                    localStorage.setItem('admin_compact_mode', isCompact);
                });
                
                // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –∑ localStorage
                if (localStorage.getItem('admin_compact_mode') === 'true') {
                    document.body.classList.add('compact-mode');
                    toggle.textContent = '–ó–≤–∏—á–∞–π–Ω–∏–π –≤–∏–≥–ª—è–¥';
                }
                
                header.appendChild(toggle);
            }
        };
        
        createCompactToggle();
        
        console.log('‚úÖ Beauty Shop Admin JS initialized');
    });
    
    // ============================================
    // ANIMATIONS
    // ============================================
    
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .compact-mode #result_list th,
        .compact-mode #result_list td {
            padding: 4px 6px !important;
            font-size: 12px !important;
        }
        
        .compact-mode .admin-thumbnail-small {
            width: 35px !important;
            height: 35px !important;
        }
    `;
    document.head.appendChild(style);
    
})();

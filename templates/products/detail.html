{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Beauty Shop{% endblock %}
{% block description %}{{ product.meta_description|default:product.description|truncatewords:30 }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail">
    <div class="container">
        
        <div class="product-detail-grid">
            <!-- –ì–∞–ª–µ—Ä–µ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å -->
            <div class="product-gallery">
                <div class="product-main-image" id="mainImage">
                    {% if product.images.all %}
                        <img src="{{ product.images.first.get_image_url }}" alt="{{ product.name }}" id="currentImage">
                    {% else %}
                        <div class="product-placeholder">
                            <span>üì¶</span>
                        </div>
                    {% endif %}
                </div>
                
                {% if product.images.count > 1 %}
                <div class="product-thumbnails">
                    {% for image in product.images.all %}
                    <div class="thumbnail {% if forloop.first %}active{% endif %}" data-image="{{ image.get_image_url }}">
                        <img src="{{ image.get_image_url }}" alt="{{ image.alt_text|default:product.name }}">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ç–æ–≤–∞—Ä -->
            <div class="product-info">
                <h1>{{ product.name }}</h1>
                
                {% if product.sku %}
                <div class="product-sku">–ê—Ä—Ç–∏–∫—É–ª: {{ product.sku }}</div>
                {% endif %}
                
                <!-- –ë–µ–π–¥–∂—ñ -->
                {% if product.is_sale or product.is_new or product.is_top %}
                <div class="product-badges">
                    {% if product.is_sale %}
                        <span class="badge badge-sale">SALE -{{ product.get_discount_percentage }}%</span>
                    {% endif %}
                    {% if product.is_new %}
                        <span class="badge badge-new">NEW</span>
                    {% endif %}
                    {% if product.is_top %}
                        <span class="badge badge-top">TOP</span>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- –¶—ñ–Ω–∞ -->
                <div class="product-detail-price">
                    {% if product.is_sale and product.sale_price %}
                        <span class="price-new">{{ product.sale_price }} ‚Ç¥</span>
                        <span class="price-old">{{ product.retail_price }} ‚Ç¥</span>
                    {% else %}
                        <span class="price-current">{{ product.retail_price }} ‚Ç¥</span>
                    {% endif %}
                </div>
                
                <!-- –ì—Ä–∞–¥–∞—Ü—ñ—è —Ü—ñ–Ω -->
                {% if product.price_3_qty or product.price_5_qty %}
                <div class="price-tiers">
                    <h3>–í–∏–≥—ñ–¥–Ω—ñ —Ü—ñ–Ω–∏ –ø—Ä–∏ –ø–æ–∫—É–ø—Ü—ñ:</h3>
                    <ul>
                        {% if product.price_3_qty %}
                        <li>–í—ñ–¥ 3 —à—Ç - {{ product.price_3_qty }} ‚Ç¥</li>
                        {% endif %}
                        {% if product.price_5_qty %}
                        <li>–í—ñ–¥ 5 —à—Ç - {{ product.price_5_qty }} ‚Ç¥</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- –ù–∞—è–≤–Ω—ñ—Å—Ç—å -->
                <div class="product-stock">
                    {% if product.is_in_stock %}
                        <span class="stock-available">‚úì –í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ ({{ product.stock }} —à—Ç)</span>
                    {% else %}
                        <span class="stock-unavailable">‚úó –ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
                    {% endif %}
                </div>
                
                <!-- –û–ø–∏—Å -->
                {% if product.description %}
                <div class="product-description">
                    {{ product.description|safe }}
                </div>
                {% endif %}
                
                <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                {% if product.attributes.all %}
                <div class="product-attributes">
                    <h3>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</h3>
                    {% for attr in product.attributes.all %}
                    <div class="attribute-row">
                        <span class="attribute-name">{{ attr.name }}:</span>
                        <span class="attribute-value">{{ attr.value }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- –î—ñ—ó -->
                {% if product.is_in_stock %}
                <div class="product-detail-actions">
                    <div class="quantity-selector">
                        <button class="quantity-btn" data-action="decrease">‚àí</button>
                        <input type="number" class="quantity-input" value="1" min="1" max="{{ product.stock }}" id="productQuantity">
                        <button class="quantity-btn" data-action="increase">+</button>
                    </div>
                    <button class="btn-primary btn-add-cart" data-product-id="{{ product.id }}">
                        –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫
                    </button>
                    <button class="btn-wishlist" data-product-id="{{ product.id }}" title="–î–æ–¥–∞—Ç–∏ –≤ —Å–ø–∏—Å–æ–∫ –±–∞–∂–∞–Ω—å">
                        ‚ô°
                    </button>
                </div>
                {% endif %}
                
                <!-- –ö–∞—Ç–µ–≥–æ—Ä—ñ—è -->
                <div class="product-category-link">
                    <a href="{{ product.category.get_absolute_url }}">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó "{{ product.category.name }}"</a>
                </div>
            </div>
        </div>
        
        <!-- –°—Ö–æ–∂—ñ —Ç–æ–≤–∞—Ä–∏ -->
        {% with similar=product.get_similar_products %}
        {% if similar %}
        <section class="similar-products">
            <h2 class="section-title text-center">–°—Ö–æ–∂—ñ —Ç–æ–≤–∞—Ä–∏</h2>
            <div class="products-grid">
                {% for item in similar %}
                <div class="product-card">
                    <a href="{{ item.get_absolute_url }}" class="product-link">
                        <div class="product-image">
                            {% if item.images.first %}
                                <img src="{{ item.images.first.get_image_url }}" alt="{{ item.name }}" loading="lazy">
                            {% else %}
                                <div class="product-placeholder">
                                    <span>üì¶</span>
                                </div>
                            {% endif %}
                            
                            {% if item.is_sale or item.is_new or item.is_top %}
                            <div class="product-badges">
                                {% if item.is_sale %}
                                    <span class="badge badge-sale">SALE</span>
                                {% endif %}
                                {% if item.is_new %}
                                    <span class="badge badge-new">NEW</span>
                                {% endif %}
                                {% if item.is_top %}
                                    <span class="badge badge-top">TOP</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="product-content">
                            <h3 class="product-name">{{ item.name }}</h3>
                            <div class="product-price">
                                {% if item.is_sale and item.sale_price %}
                                    <span class="price-old">{{ item.retail_price }} ‚Ç¥</span>
                                    <span class="price-new">{{ item.sale_price }} ‚Ç¥</span>
                                {% else %}
                                    <span class="price-current">{{ item.retail_price }} ‚Ç¥</span>
                                {% endif %}
                            </div>
                        </div>
                    </a>
                    
                    <div class="product-actions">
                        <button class="btn-add-cart" data-product-id="{{ item.id }}">
                            –î–æ –∫–æ—à–∏–∫–∞
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
        {% endwith %}
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
    const thumbnails = document.querySelectorAll('.thumbnail');
    const currentImage = document.getElementById('currentImage');
    
    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const imageUrl = this.dataset.image;
            if (currentImage) {
                currentImage.src = imageUrl;
            }
            
            thumbnails.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—é
    const quantityInput = document.getElementById('productQuantity');
    const quantityBtns = document.querySelectorAll('.quantity-btn');
    
    quantityBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.dataset.action;
            let value = parseInt(quantityInput.value);
            const max = parseInt(quantityInput.max);
            
            if (action === 'increase' && value < max) {
                quantityInput.value = value + 1;
            } else if (action === 'decrease' && value > 1) {
                quantityInput.value = value - 1;
            }
        });
    });
    
    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤ –∫–æ—à–∏–∫
    const addToCartBtns = document.querySelectorAll('.btn-add-cart');
    addToCartBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
            
            fetch('/cart/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `product_id=${productId}&quantity=${quantity}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫!');
                    updateCartCount(data.cart_count);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è CSRF —Ç–æ–∫–µ–Ω—É
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ –∫–æ—à–∏–∫–∞
    function updateCartCount(count) {
        const cartCount = document.querySelector('.cart-count');
        if (cartCount) {
            cartCount.textContent = count;
        }
    }
});
</script>
{% endblock %}


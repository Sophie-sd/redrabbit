{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Beauty Shop{% endblock %}
{% block description %}{{ product.meta_description|default:product.description|truncatewords:30 }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/products.css' %}">
{% endblock %}

{% block content %}
<div class="product-detail">
    <div class="container">
        
        <div class="product-detail-grid">
            <!-- –ì–∞–ª–µ—Ä–µ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å -->
            <div class="product-gallery">
                <div class="product-main-image" id="mainImage">
                    {% if product.images.all %}
                        <img src="{{ product.images.first.get_image_url }}" alt="{{ product.name }}" id="currentImage">
                    {% else %}
                        <div class="product-placeholder">
                            <span>üì¶</span>
                        </div>
                    {% endif %}
                </div>
                
                {% if product.images.count > 1 %}
                <div class="product-thumbnails">
                    {% for image in product.images.all %}
                    <div class="thumbnail {% if forloop.first %}active{% endif %}" data-image="{{ image.get_image_url }}">
                        <img src="{{ image.get_image_url }}" alt="{{ image.alt_text|default:product.name }}">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ç–æ–≤–∞—Ä -->
            <div class="product-info">
                <h1>{{ product.name }}</h1>
                
                {% if product.sku %}
                <div class="product-sku">–ê—Ä—Ç–∏–∫—É–ª: {{ product.sku }}</div>
                {% endif %}
                
                <!-- –î—ñ—ó -->
                {% if product.is_in_stock %}
                <div class="product-detail-actions">
                    <div class="quantity-selector">
                        <button class="quantity-btn" data-action="decrease">‚àí</button>
                        <input type="number" class="quantity-input" value="1" min="1" max="{{ product.stock }}" id="productQuantity">
                        <button class="quantity-btn" data-action="increase">+</button>
                    </div>
                    <button class="btn-primary btn-add-cart" data-product-id="{{ product.id }}">
                        –î–æ–¥–∞—Ç–∏ –≤ –∫–æ—à–∏–∫
                    </button>
                    <button class="btn-wishlist" data-product-id="{{ product.id }}" title="–î–æ–¥–∞—Ç–∏ –≤ –æ–±—Ä–∞–Ω–µ">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </button>
                </div>
                {% endif %}
                
                <!-- –ë–µ–π–¥–∂—ñ -->
                <div class="product-badges">
                    {% include 'includes/sale_countdown.html' with product=product %}
                    {% if product.is_new %}
                        <span class="badge badge-new">NEW</span>
                    {% endif %}
                    {% if product.is_top %}
                        <span class="badge badge-top">TOP</span>
                    {% endif %}
                </div>
                
                <!-- –¶—ñ–Ω–∞ -->
                <div class="product-detail-price">
                    {% if product.is_sale_active %}
                        <span class="price-new">{{ product.sale_price }} ‚Ç¥</span>
                        <span class="price-old">{{ product.retail_price }} ‚Ç¥</span>
                    {% else %}
                        <span class="price-current">{{ product.retail_price }} ‚Ç¥</span>
                    {% endif %}
                </div>
                
                <!-- –ì—Ä–∞–¥–∞—Ü—ñ—è —Ü—ñ–Ω -->
                {% if product.price_3_qty or product.price_5_qty %}
                <div class="price-tiers">
                    <h3>–í–∏–≥—ñ–¥–Ω—ñ —Ü—ñ–Ω–∏ –ø—Ä–∏ –ø–æ–∫—É–ø—Ü—ñ:</h3>
                    <ul>
                        {% if product.price_3_qty %}
                        <li>–í—ñ–¥ 3 —à—Ç - {{ product.price_3_qty }} ‚Ç¥</li>
                        {% endif %}
                        {% if product.price_5_qty %}
                        <li>–í—ñ–¥ 5 —à—Ç - {{ product.price_5_qty }} ‚Ç¥</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- –ù–∞—è–≤–Ω—ñ—Å—Ç—å -->
                <div class="product-stock">
                    {% if product.is_in_stock %}
                        <span class="stock-available">‚úì –í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ ({{ product.stock }} —à—Ç)</span>
                    {% else %}
                        <span class="stock-unavailable">‚úó –ù–µ–º–∞—î –≤ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
                    {% endif %}
                </div>
                
                <!-- –û–ø–∏—Å -->
                {% if product.description %}
                <div class="product-description">
                    {{ product.description|safe }}
                </div>
                {% endif %}
                
                <!-- –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ -->
                {% if product.attributes.all %}
                <div class="product-attributes">
                    <h3>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</h3>
                    {% for attr in product.attributes.all %}
                    <div class="attribute-row">
                        <span class="attribute-name">{{ attr.name }}:</span>
                        <span class="attribute-value">{{ attr.value }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <!-- –ö–∞—Ç–µ–≥–æ—Ä—ñ—è -->
                <div class="product-category-link">
                    <a href="{{ product.category.get_absolute_url }}">‚Üê –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó "{{ product.category.name }}"</a>
                </div>
            </div>
        </div>
        
        <!-- –°—Ö–æ–∂—ñ —Ç–æ–≤–∞—Ä–∏ -->
        {% with similar=product.get_similar_products %}
        {% if similar %}
        <section class="similar-products">
            <h2 class="section-title text-center">–°—Ö–æ–∂—ñ —Ç–æ–≤–∞—Ä–∏</h2>
            <div class="products-grid">
                {% for item in similar %}
                <article class="product-card">
                    <div class="product-card__media">
                        {% if item.images.first %}
                            <img 
                                src="{{ item.images.first.get_image_url }}" 
                                alt="{{ item.name }}" 
                                class="product-card__image"
                                loading="lazy"
                            >
                        {% else %}
                            <div class="product-card__placeholder">üì¶</div>
                        {% endif %}
                        
                        <button 
                            type="button"
                            class="product-card__wishlist" 
                            data-product-id="{{ item.id }}" 
                            aria-label="–î–æ–¥–∞—Ç–∏ –≤ –æ–±—Ä–∞–Ω–µ"
                            title="–î–æ–¥–∞—Ç–∏ –≤ –æ–±—Ä–∞–Ω–µ"
                        >
                            <span class="product-card__wishlist-icon">‚ô°</span>
                        </button>
                        
                        <div class="product-card__badges">
                            {% include 'includes/sale_countdown.html' with product=item %}
                            {% if item.is_new %}
                                <span class="product-badge product-badge--new">NEW</span>
                            {% endif %}
                            {% if item.is_top %}
                                <span class="product-badge product-badge--hit">–•–Ü–¢</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="product-card__content">
                        <h3 class="product-card__name">
                            <a href="{{ item.get_absolute_url }}" class="product-card__link">
                                {{ item.name }}
                            </a>
                        </h3>
                        
                        <div class="product-card__price">
                            {% if item.is_sale_active %}
                                <span class="product-card__price-current">{{ item.sale_price }} ‚Ç¥</span>
                                <span class="product-card__price-old">{{ item.retail_price }} ‚Ç¥</span>
                            {% else %}
                                <span class="product-card__price-current">{{ item.retail_price }} ‚Ç¥</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="product-card__actions">
                        <button 
                            type="button"
                            class="product-card__add-cart" 
                            data-product-id="{{ item.id }}"
                        >
                            –î–æ –∫–æ—à–∏–∫–∞
                        </button>
                    </div>
                </article>
                {% endfor %}
            </div>
        </section>
        {% endif %}
        {% endwith %}
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω—å
    const thumbnails = document.querySelectorAll('.thumbnail');
    const currentImage = document.getElementById('currentImage');
    
    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            const imageUrl = this.dataset.image;
            if (currentImage) {
                currentImage.src = imageUrl;
            }
            
            thumbnails.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—é
    const quantityInput = document.getElementById('productQuantity');
    const quantityBtns = document.querySelectorAll('.quantity-btn');
    
    quantityBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.dataset.action;
            let value = parseInt(quantityInput.value);
            const max = parseInt(quantityInput.max);
            
            if (action === 'increase' && value < max) {
                quantityInput.value = value + 1;
            } else if (action === 'decrease' && value > 1) {
                quantityInput.value = value - 1;
            }
        });
    });
    
    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤ –æ–±—Ä–∞–Ω–µ
    const wishlistBtn = document.querySelector('.btn-wishlist');
    if (wishlistBtn) {
        wishlistBtn.addEventListener('click', function() {
            const productId = this.dataset.productId;
            
            fetch('/wishlist/toggle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ product_id: productId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.added) {
                    this.classList.add('active');
                    alert('–î–æ–¥–∞–Ω–æ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ!');
                } else {
                    this.classList.remove('active');
                    alert('–í–∏–¥–∞–ª–µ–Ω–æ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }
    
    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤ –∫–æ—à–∏–∫ (–æ—Å–Ω–æ–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞)
    const mainAddToCartBtn = document.querySelector('.product-detail-actions .btn-add-cart');
    if (mainAddToCartBtn) {
        mainAddToCartBtn.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
            
            fetch('/cart/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `product_id=${productId}&quantity=${quantity}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫!');
                    updateCartCount(data.cart_count);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }
    
    // –î–æ–¥–∞–≤–∞–Ω–Ω—è –≤ –∫–æ—à–∏–∫ (—Å—Ö–æ–∂—ñ —Ç–æ–≤–∞—Ä–∏)
    const similarAddToCartBtns = document.querySelectorAll('.similar-products .product-card__add-cart');
    similarAddToCartBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.dataset.productId;
            
            fetch('/cart/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `product_id=${productId}&quantity=1`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–¢–æ–≤–∞—Ä –¥–æ–¥–∞–Ω–æ –≤ –∫–æ—à–∏–∫!');
                    updateCartCount(data.cart_count);
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
    
    // Wishlist –¥–ª—è —Å—Ö–æ–∂–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤
    const similarWishlistBtns = document.querySelectorAll('.similar-products .product-card__wishlist');
    similarWishlistBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const productId = this.dataset.productId;
            
            fetch('/wishlist/toggle/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ product_id: productId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.added) {
                    this.classList.add('active');
                    alert('–î–æ–¥–∞–Ω–æ –¥–æ –æ–±—Ä–∞–Ω–æ–≥–æ!');
                } else {
                    this.classList.remove('active');
                    alert('–í–∏–¥–∞–ª–µ–Ω–æ –∑ –æ–±—Ä–∞–Ω–æ–≥–æ');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
    
    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è CSRF —Ç–æ–∫–µ–Ω—É
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞ –∫–æ—à–∏–∫–∞
    function updateCartCount(count) {
        const cartCount = document.querySelector('.cart-count');
        if (cartCount) {
            cartCount.textContent = count;
        }
    }
});
</script>
{% endblock %}


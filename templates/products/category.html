{% extends 'base.html' %}
{% load static %}
{% load product_filters %}

{% block title %}{{ category.name }} - Beauty Shop{% endblock %}
{% block description %}{{ category.meta_description|default:category.description|truncatewords:20 }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/catalog.css' %}">
<link rel="stylesheet" href="{% static 'css/categories-visual.css' %}">
{% endblock %}

{% block content %}
<div class="catalog-container">
    <header class="catalog-header catalog-header--{{ category.category_type }}">
        <h1 class="catalog-title">
            {% if category.icon %}<span class="category-icon">{{ category.icon }}</span>{% endif %}
            {{ category.name }}
        </h1>
        {% if category.description %}
            <p class="catalog-subtitle">{{ category.description }}</p>
        {% endif %}
    </header>
    
    <div class="catalog-layout">
        <aside class="catalog-sidebar" id="catalogSidebar">
            {% include 'includes/sidebar-menu.html' %}
        </aside>
        
        <main class="catalog-main">
            {% if not subcategories %}
            <div class="filters-bar filters-bar--{{ category.category_type }}">
                <div class="filters-controls">
                    <button type="button" class="filters-toggle" id="filtersToggle">
                        <svg class="filters-toggle__icon" viewBox="0 0 24 24" fill="none">
                            <path d="M3 4H21V6H3V4ZM6 10H18V12H6V10ZM9 16H15V18H9V16Z" fill="currentColor"/>
                        </svg>
                        <span class="filters-toggle__text">–§—ñ–ª—å—Ç—Ä–∏</span>
                        <svg class="filters-toggle__arrow" viewBox="0 0 24 24" fill="none">
                            <path d="M7 10L12 15L17 10H7Z" fill="currentColor"/>
                        </svg>
                    </button>
                    
                    <div class="desktop-sort-control">
                        <button type="button" class="desktop-sort-btn" id="desktopSortBtn">
                            <svg class="sort-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M3 6h18M3 12h13M3 18h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span class="sort-text">–°–æ—Ä—Ç—É–≤–∞—Ç–∏</span>
                            <svg class="sort-arrow" viewBox="0 0 24 24" fill="none">
                                <path d="M7 10L12 15L17 10H7Z" fill="currentColor"/>
                            </svg>
                        </button>
                        <div class="desktop-sort-dropdown hidden" id="desktopSortDropdown">
                            <div class="sort-option" data-value="default">–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º</div>
                            <div class="sort-option" data-value="price_asc">–ó–∞ —Ü—ñ–Ω–æ—é: –¥–µ—à–µ–≤—à—ñ —Å–ø–æ—á–∞—Ç–∫—É</div>
                            <div class="sort-option" data-value="price_desc">–ó–∞ —Ü—ñ–Ω–æ—é: –¥–æ—Ä–æ–∂—á—ñ —Å–ø–æ—á–∞—Ç–∫—É</div>
                            <div class="sort-option" data-value="name">–ó–∞ –Ω–∞–∑–≤–æ—é</div>
                            <div class="sort-option" data-value="popular">–ó–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ñ—Å—Ç—é</div>
                            <div class="sort-option" data-value="new">–ó–∞ –Ω–æ–≤–∏–∑–Ω–æ—é</div>
                        </div>
                    </div>
                </div>
                
                <div class="filters-content" id="filtersContent">
                    <div class="filters-grid">
                        {% if available_subcategories %}
                        <div class="filter-group">
                            <label class="filter-label">–†–æ–∑–¥—ñ–ª</label>
                            <div class="filter-checkboxes filter-checkboxes--scrollable">
                                {% for subcat in available_subcategories %}
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="{{ subcat.slug }}" name="subcategory" class="filter-checkbox-input">
                                    <span>{{ subcat.name }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="filter-group">
                            <label class="filter-label">–¶—ñ–Ω–∞, ‚Ç¥</label>
                            <div class="price-inputs">
                                <input type="number" class="price-input" id="priceMin" placeholder="–í—ñ–¥ {{ min_price|default:0 }}" min="0">
                                <span>‚Äî</span>
                                <input type="number" class="price-input" id="priceMax" placeholder="–î–æ {{ max_price|default:10000 }}" min="0">
                            </div>
                        </div>
                        
                        <div class="filter-group filter-group--actions">
                            <button type="button" class="filters-clear-btn" id="clearAllFilters">–û—á–∏—Å—Ç–∏—Ç–∏</button>
                            <button type="button" class="filters-apply-btn" id="applyFiltersBtn">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if not subcategories %}
            <div class="mobile-controls">
                <button type="button" class="mobile-filters-btn" id="mobileFiltersBtn">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 4H21V6H3V4ZM6 10H18V12H6V10ZM9 16H15V18H9V16Z" fill="currentColor"/>
                    </svg>
                    <span>–§—ñ–ª—å—Ç—Ä–∏</span>
                    <span class="filters-count hidden" id="mobileFiltersCount">(0)</span>
                </button>
                
                <div class="sort-control">
                    <button type="button" class="sort-select-btn" id="sortSelectBtn">
                        <span class="sort-select-text">–°–æ—Ä—Ç—É–≤–∞—Ç–∏</span>
                        <svg class="sort-select-arrow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7 10L12 15L17 10H7Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <div class="sort-dropdown hidden" id="sortDropdown">
                        <div class="sort-option" data-value="default">–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º</div>
                        <div class="sort-option" data-value="price_asc">–ó–∞ —Ü—ñ–Ω–æ—é: –¥–µ—à–µ–≤—à—ñ —Å–ø–æ—á–∞—Ç–∫—É</div>
                        <div class="sort-option" data-value="price_desc">–ó–∞ —Ü—ñ–Ω–æ—é: –¥–æ—Ä–æ–∂—á—ñ —Å–ø–æ—á–∞—Ç–∫—É</div>
                        <div class="sort-option" data-value="name">–ó–∞ –Ω–∞–∑–≤–æ—é</div>
                        <div class="sort-option" data-value="popular">–ó–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ñ—Å—Ç—é</div>
                        <div class="sort-option" data-value="new">–ó–∞ –Ω–æ–≤–∏–∑–Ω–æ—é</div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="active-filters hidden" id="activeFilters"></div>
        
        {% if products %}
            <div class="products-grid" id="productsGrid" role="main" aria-live="polite">
                {% for product in products %}
                    {% include 'includes/product_card.html' with product=product %}
                {% endfor %}
            </div>
        {% else %}
            <!-- –ü–æ—Ä–æ–∂–Ω—ñ–π —Å—Ç–∞–Ω -->
            <div class="empty-state" role="status" aria-live="polite">
                <div class="empty-state__icon" aria-hidden="true">üõçÔ∏è</div>
                <h2 class="empty-state__title">–í —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø–æ–∫–∏ –Ω–µ–º–∞—î —Ç–æ–≤–∞—Ä—ñ–≤</h2>
                <p class="empty-state__description">
                    –°–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —ñ–Ω—à—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∞–±–æ –∑–º—ñ–Ω–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏ –ø–æ—à—É–∫—É
                </p>
                <div class="empty-state__actions">
                    <a href="/" class="empty-state__button empty-state__button--primary">
                        ‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É
                    </a>
                    <button type="button" class="empty-state__button empty-state__button--secondary" id="clearAllFilters">
                        –°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏
                    </button>
                </div>
            </div>
        {% endif %}
        
        <!-- Skeleton loader –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
        <div class="products-grid hidden" id="skeletonGrid" aria-hidden="true">
            {% for i in "123456789012" %}
                <div class="product-card-skeleton">
                    <div class="product-card-skeleton__media skeleton"></div>
                    <div class="product-card-skeleton__content">
                        <div class="product-card-skeleton__name skeleton"></div>
                        <div class="product-card-skeleton__price skeleton"></div>
                        <div class="product-card-skeleton__button skeleton"></div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
        {% if is_paginated %}
            <nav class="pagination" role="navigation" aria-label="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è –ø–æ —Å—Ç–æ—Ä—ñ–Ω–∫–∞—Ö">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="pagination__link" aria-label="–ü–µ—Ä—à–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞">‚ü®‚ü®</a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="pagination__link" aria-label="–ü–æ–ø–µ—Ä–µ–¥–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞">‚ü®</a>
                {% else %}
                    <span class="pagination__link pagination__link--disabled" aria-disabled="true">‚ü®‚ü®</span>
                    <span class="pagination__link pagination__link--disabled" aria-disabled="true">‚ü®</span>
                {% endif %}
                
                <span class="pagination__info" aria-live="polite">
                    –°—Ç–æ—Ä—ñ–Ω–∫–∞ {{ page_obj.number }} –∑ {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="pagination__link" aria-label="–ù–∞—Å—Ç—É–ø–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞">‚ü©</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="pagination__link" aria-label="–û—Å—Ç–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞">‚ü©‚ü©</a>
                {% else %}
                    <span class="pagination__link pagination__link--disabled" aria-disabled="true">‚ü©</span>
                    <span class="pagination__link pagination__link--disabled" aria-disabled="true">‚ü©‚ü©</span>
                {% endif %}
            </nav>
            
            <!-- –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞ –ø–∞–≥—ñ–Ω–∞—Ü—ñ—è –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö -->
            <div class="pagination-mobile hidden">
                {% if page_obj.has_next %}
                    <button type="button" class="pagination__load-more" id="loadMoreBtn" data-next-page="{{ page_obj.next_page_number }}">
                        –ü–æ–∫–∞–∑–∞—Ç–∏ —â–µ —Ç–æ–≤–∞—Ä–∏
                    </button>
                {% endif %}
            </div>
        {% endif %}
        </main>
    </div>
</div>

<div class="mobile-filters-modal" id="mobileFiltersModal">
    <div class="modal-filters__content">
        <div class="modal-filters__header">
            <h3 class="modal-filters__title">–§—ñ–ª—å—Ç—Ä–∏</h3>
            <button type="button" class="modal-filters__close" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">‚úï</button>
        </div>
        <div class="modal-filters__body"></div>
        <div class="modal-filters__footer">
            <button type="button" class="modal-filters__clear">–û—á–∏—Å—Ç–∏—Ç–∏</button>
            <button type="button" class="modal-filters__apply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/catalog_new.js' %}"></script>
{% endblock %}


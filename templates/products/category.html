{% extends 'base.html' %}
{% load static %}
{% load product_filters %}

{% block title %}{{ category.name }} - Beauty Shop{% endblock %}
{% block description %}{{ category.meta_description|default:category.description|truncatewords:20 }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/catalog.css' %}">
{% endblock %}

{% block content %}
<div class="catalog-container">
    <header class="catalog-header">
        <h1 class="catalog-title">{{ category.name }}</h1>
        {% if category.description %}
            <p class="catalog-subtitle">{{ category.description }}</p>
        {% endif %}
    </header>
    
    <div class="catalog-layout">
        <aside class="catalog-sidebar" id="catalogSidebar">
            {% include 'includes/sidebar-menu.html' %}
        </aside>
        
        <main class="catalog-main">
            {% if not subcategories %}
            <div class="filters-bar">
                <div class="filters-controls">
                    <button type="button" class="filters-toggle" id="filtersToggle">
                        <svg class="filters-toggle__icon" viewBox="0 0 24 24" fill="none">
                            <path d="M3 4H21V6H3V4ZM6 10H18V12H6V10ZM9 16H15V18H9V16Z" fill="currentColor"/>
                        </svg>
                        <span class="filters-toggle__text">Фільтри</span>
                        <svg class="filters-toggle__arrow" viewBox="0 0 24 24" fill="none">
                            <path d="M7 10L12 15L17 10H7Z" fill="currentColor"/>
                        </svg>
                    </button>
                    
                    <div class="desktop-sort-control">
                        <button type="button" class="desktop-sort-btn" id="desktopSortBtn">
                            <svg class="sort-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M3 6h18M3 12h13M3 18h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            <span class="sort-text">Сортувати</span>
                            <svg class="sort-arrow" viewBox="0 0 24 24" fill="none">
                                <path d="M7 10L12 15L17 10H7Z" fill="currentColor"/>
                            </svg>
                        </button>
                        <div class="desktop-sort-dropdown hidden" id="desktopSortDropdown">
                            <div class="sort-option" data-value="default">За замовчуванням</div>
                            <div class="sort-option" data-value="price_asc">За ціною: дешевші спочатку</div>
                            <div class="sort-option" data-value="price_desc">За ціною: дорожчі спочатку</div>
                            <div class="sort-option" data-value="name">За назвою</div>
                            <div class="sort-option" data-value="popular">За популярністю</div>
                            <div class="sort-option" data-value="new">За новизною</div>
                        </div>
                    </div>
                </div>
                
                <div class="filters-content" id="filtersContent">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Ціна, ₴</label>
                            <div class="price-inputs">
                                <input type="number" class="price-input" id="priceMin" placeholder="Від" min="0">
                                <span>—</span>
                                <input type="number" class="price-input" id="priceMax" placeholder="До" min="0">
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Наявність</label>
                            <div class="filter-checkboxes">
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="in_stock" name="availability" class="filter-checkbox-input">
                                    <span>В наявності</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="out_of_stock" name="availability" class="filter-checkbox-input">
                                    <span>Під замовлення</span>
                                </label>
                            </div>
                        </div>
                        
                        {% if available_brands %}
                        <div class="filter-group">
                            <label class="filter-label">Бренд</label>
                            <div class="filter-checkboxes filter-checkboxes--scrollable">
                                {% for brand in available_brands %}
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="{{ brand }}" name="brand" class="filter-checkbox-input">
                                    <span>{{ brand|cut:" (Польща)"|cut:" (Німеччина)"|cut:" (США)"|cut:" (Франція)"|cut:" (Японія)"|cut:" (Япония)"|cut:" (Україна)"|cut:" (Китай)"|cut:" (Південна Корея)"|cut:" (Великобританія)" }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if available_power %}
                        <div class="filter-group">
                            <label class="filter-label">Живлення</label>
                            <div class="filter-checkboxes">
                                {% for power in available_power %}
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="{{ power }}" name="power" class="filter-checkbox-input">
                                    <span>{% if power == "вбудовані акумулятори" %}Акумулятор{% elif power == "батарейки" %}Батарейки{% elif power == "від мережі 220V" %}Мережа 220V{% else %}{{ power }}{% endif %}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if available_waterproof %}
                        <div class="filter-group">
                            <label class="filter-label">Водостійкість</label>
                            <div class="filter-checkboxes">
                                {% for waterproof in available_waterproof %}
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="{{ waterproof }}" name="waterproof" class="filter-checkbox-input">
                                    <span>{% if waterproof == "можна занурювати" %}Повністю водостійкий{% elif waterproof == "водостійка" %}Водостійкий{% elif waterproof == "захист від бризок" %}Захист від бризок{% else %}{{ waterproof }}{% endif %}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if available_vibration %}
                        <div class="filter-group">
                            <label class="filter-label">Вібрація</label>
                            <div class="filter-checkboxes">
                                {% for vibration in available_vibration %}
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="{{ vibration }}" name="vibration" class="filter-checkbox-input">
                                    <span>{% if vibration == "так" %}З вібрацією{% elif vibration == "ні" %}Без вібрації{% else %}{{ vibration }}{% endif %}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="filter-group">
                            <label class="filter-label">Тип товару</label>
                            <div class="filter-checkboxes">
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="new" name="type" class="filter-checkbox-input">
                                    <span>Новинки</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="sale" name="type" class="filter-checkbox-input">
                                    <span>Акційні</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="top" name="type" class="filter-checkbox-input">
                                    <span>Хіти продажу</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="filter-group filter-group--actions">
                            <button type="button" class="filters-clear-btn" id="clearAllFilters">Очистити</button>
                            <button type="button" class="filters-apply-btn" id="applyFiltersBtn">Застосувати</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if not subcategories %}
            <div class="mobile-controls">
                <button type="button" class="mobile-filters-btn" id="mobileFiltersBtn">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 4H21V6H3V4ZM6 10H18V12H6V10ZM9 16H15V18H9V16Z" fill="currentColor"/>
                    </svg>
                    <span>Фільтри</span>
                    <span class="filters-count hidden" id="mobileFiltersCount">(0)</span>
                </button>
                
                <div class="sort-control">
                    <button type="button" class="sort-select-btn" id="sortSelectBtn">
                        <span class="sort-select-text">Сортувати</span>
                        <svg class="sort-select-arrow" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7 10L12 15L17 10H7Z" fill="currentColor"/>
                        </svg>
                    </button>
                    <div class="sort-dropdown hidden" id="sortDropdown">
                        <div class="sort-option" data-value="default">За замовчуванням</div>
                        <div class="sort-option" data-value="price_asc">За ціною: дешевші спочатку</div>
                        <div class="sort-option" data-value="price_desc">За ціною: дорожчі спочатку</div>
                        <div class="sort-option" data-value="name">За назвою</div>
                        <div class="sort-option" data-value="popular">За популярністю</div>
                        <div class="sort-option" data-value="new">За новизною</div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="active-filters hidden" id="activeFilters"></div>
        
        {% if products %}
            <div class="products-grid" id="productsGrid" role="main" aria-live="polite">
                {% for product in products %}
                    <article class="product-card" 
                         data-price="{{ product.retail_price }}" 
                         data-sale-price="{{ product.sale_price|default:product.retail_price }}"
                         data-in-stock="{{ product.is_in_stock }}"
                         data-is-sale="{{ product.is_sale }}"
                         data-is-new="{{ product.is_new }}"
                         data-is-top="{{ product.is_top }}"
                         data-vendor="{{ product.vendor_name }}"
                         data-power="{{ product|get_attribute:'Живлення' }}"
                         data-waterproof="{{ product|get_attribute:'Водостійкість' }}"
                         data-vibration="{{ product|get_attribute:'Вібрація' }}"
                         data-material="{{ product|get_attribute:'Матеріал' }}"
                         data-name="{{ product.name }}">
                         
                        <!-- Медіаблок -->
                        <div class="product-card__media">
                            {% if product.images.first %}
                                <img 
                                    src="{{ product.images.first.get_image_url }}" 
                                    alt="{{ product.name }}" 
                                    class="product-card__image"
                                    loading="lazy"
                                    width="300"
                                    height="300"
                                >
                            {% else %}
                                <div class="product-card__placeholder" aria-label="Зображення товару відсутнє">
                                    📦
                                </div>
                            {% endif %}
                            
                            <!-- Кнопка обраного -->
                            <button 
                                type="button"
                                class="product-card__wishlist" 
                                data-product-id="{{ product.id }}" 
                                aria-label="Додати в обране"
                                title="Додати в обране"
                            >
                                <span class="product-card__wishlist-icon" aria-hidden="true">♡</span>
                            </button>
                            
                            <!-- Бейджі -->
                            {% if product.is_sale_active or product.is_new or product.is_top %}
                                <div class="product-card__badges">
                                    {% if product.is_sale_active %}
                                        <span class="product-badge product-badge--sale" aria-label="Знижка">
                                            -{{ product.get_discount_percentage }}%
                                        </span>
                                    {% endif %}
                                    {% if product.is_new %}
                                        <span class="product-badge product-badge--new" aria-label="Новинка">
                                            NEW
                                        </span>
                                    {% endif %}
                                    {% if product.is_top %}
                                        <span class="product-badge product-badge--hit" aria-label="Хіт продажу">
                                            ХІТ
                                        </span>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Контент картки -->
                        <div class="product-card__content">
                            <h3 class="product-card__name" title="{{ product.name }}">
                                <a href="{{ product.get_absolute_url }}" class="product-card__link">
                                    {{ product.name }}
                                </a>
                            </h3>
                            
                            <div class="product-card__price">
                                {% if product.is_sale_active %}
                                    <span class="product-card__price-current" aria-label="Акційна ціна">
                                        {{ product.sale_price }} ₴
                                    </span>
                                    <span class="product-card__price-old" aria-label="Стара ціна">
                                        {{ product.retail_price }} ₴
                                    </span>
                                    <span class="product-card__price-save" aria-label="Економія">
                                        -{{ product.get_discount_amount }} ₴
                                    </span>
                                    {% include 'includes/sale_countdown.html' with product=product %}
                                {% else %}
                                    <span class="product-card__price-current" aria-label="Ціна">
                                        {{ product.retail_price }} ₴
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Дії картки -->
                        <div class="product-card__actions">
                            {% if product.is_in_stock %}
                                <button 
                                    type="button"
                                    class="product-card__add-cart" 
                                    data-product-id="{{ product.id }}"
                                    aria-label="Додати {{ product.name }} до кошика"
                                >
                                    До кошика
                                </button>
                            {% else %}
                                <button 
                                    type="button"
                                    class="product-card__add-cart product-card__add-cart--disabled" 
                                    disabled
                                    aria-label="Товар тимчасово відсутній"
                                >
                                    Немає в наявності
                                </button>
                            {% endif %}
                        </div>
                        
                        <!-- Оверлей для товарів не в наявності -->
                        {% if not product.is_in_stock %}
                            <div class="product-card__out-of-stock-label" aria-hidden="true">
                                Немає в наявності
                            </div>
                        {% endif %}
                    </article>
                {% endfor %}
            </div>
        {% else %}
            <!-- Порожній стан -->
            <div class="empty-state" role="status" aria-live="polite">
                <div class="empty-state__icon" aria-hidden="true">🛍️</div>
                <h2 class="empty-state__title">В цій категорії поки немає товарів</h2>
                <p class="empty-state__description">
                    Спробуйте переглянути інші категорії або змінити фільтри пошуку
                </p>
                <div class="empty-state__actions">
                    <a href="/" class="empty-state__button empty-state__button--primary">
                        ← На головну
                    </a>
                    <button type="button" class="empty-state__button empty-state__button--secondary" id="clearAllFilters">
                        Скинути фільтри
                    </button>
                </div>
            </div>
        {% endif %}
        
        <!-- Skeleton loader для завантаження -->
        <div class="products-grid hidden" id="skeletonGrid" aria-hidden="true">
            {% for i in "123456789012" %}
                <div class="product-card-skeleton">
                    <div class="product-card-skeleton__media skeleton"></div>
                    <div class="product-card-skeleton__content">
                        <div class="product-card-skeleton__name skeleton"></div>
                        <div class="product-card-skeleton__price skeleton"></div>
                        <div class="product-card-skeleton__button skeleton"></div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Пагінація -->
        {% if is_paginated %}
            <nav class="pagination" role="navigation" aria-label="Навігація по сторінках">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="pagination__link" aria-label="Перша сторінка">⟨⟨</a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="pagination__link" aria-label="Попередня сторінка">⟨</a>
                {% else %}
                    <span class="pagination__link pagination__link--disabled" aria-disabled="true">⟨⟨</span>
                    <span class="pagination__link pagination__link--disabled" aria-disabled="true">⟨</span>
                {% endif %}
                
                <span class="pagination__info" aria-live="polite">
                    Сторінка {{ page_obj.number }} з {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="pagination__link" aria-label="Наступна сторінка">⟩</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="pagination__link" aria-label="Остання сторінка">⟩⟩</a>
                {% else %}
                    <span class="pagination__link pagination__link--disabled" aria-disabled="true">⟩</span>
                    <span class="pagination__link pagination__link--disabled" aria-disabled="true">⟩⟩</span>
                {% endif %}
            </nav>
            
            <!-- Альтернативна пагінація для мобільних -->
            <div class="pagination-mobile hidden">
                {% if page_obj.has_next %}
                    <button type="button" class="pagination__load-more" id="loadMoreBtn" data-next-page="{{ page_obj.next_page_number }}">
                        Показати ще товари
                    </button>
                {% endif %}
            </div>
        {% endif %}
        </main>
    </div>
</div>

<div class="mobile-filters-modal" id="mobileFiltersModal">
    <div class="modal-filters__content">
        <div class="modal-filters__header">
            <h3 class="modal-filters__title">Фільтри</h3>
            <button type="button" class="modal-filters__close" aria-label="Закрити">✕</button>
        </div>
        <div class="modal-filters__body"></div>
        <div class="modal-filters__footer">
            <button type="button" class="modal-filters__clear">Очистити</button>
            <button type="button" class="modal-filters__apply">Застосувати</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/catalog.js' %}"></script>
{% endblock %}


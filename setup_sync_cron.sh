#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
# –ó–∞–ø—É—Å–∫: ./setup_sync_cron.sh

set -e

PROJECT_DIR="/Users/sofiadmitrenko/Sites/intshop"

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë        –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ù–û–á –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–á                ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# –°—Ç–≤–æ—Ä—é—î–º–æ cron job —Ñ–∞–π–ª
CRON_FILE="/tmp/intshop_sync_cron.txt"

# –ü–æ—Ç–æ—á–Ω—ñ cron jobs
crontab -l > "$CRON_FILE" 2>/dev/null || true

# –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —è–∫—â–æ —î
grep -v "sync_with_images\|download_all_images\|update_prices\|sync_products\|update_prices_xls" "$CRON_FILE" > "${CRON_FILE}.tmp" 2>/dev/null || true
mv "${CRON_FILE}.tmp" "$CRON_FILE" 2>/dev/null || true

echo "–ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é..."
echo ""

# –î–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ –∑–∞–≤–¥–∞–Ω–Ω—è
echo "" >> "$CRON_FILE"
echo "# –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–Ω —Ç–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∑ XLS (–∫–æ–∂–Ω—ñ 2 –≥–æ–¥–∏–Ω–∏)" >> "$CRON_FILE"
echo "0 */2 * * * cd $PROJECT_DIR && python3 manage.py update_prices_xls >> /tmp/intshop_prices.log 2>&1" >> "$CRON_FILE"

echo "" >> "$CRON_FILE"
echo "# –ü–æ–≤–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ XML (—â–æ–¥–Ω—è –æ 8:30)" >> "$CRON_FILE"
echo "30 8 * * * cd $PROJECT_DIR && python3 manage.py sync_products >> /tmp/intshop_sync.log 2>&1" >> "$CRON_FILE"

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ crontab
crontab "$CRON_FILE"
rm "$CRON_FILE"

echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ —É—Å–ø—ñ—à–Ω–æ!"
echo ""
echo "üìã –†–æ–∑–∫–ª–∞–¥ –∑–∞–≤–¥–∞–Ω—å:"
echo "   ‚Ä¢ –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ü—ñ–Ω (XLS): –∫–æ–∂–Ω—ñ 2 –≥–æ–¥–∏–Ω–∏"
echo "   ‚Ä¢ –ü–æ–≤–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è (XML): —â–æ–¥–Ω—è –æ 8:30"
echo ""
echo "üìÅ –õ–æ–≥–∏:"
echo "   ‚Ä¢ –¶—ñ–Ω–∏: /tmp/intshop_prices.log"
echo "   ‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è: /tmp/intshop_sync.log"
echo ""
echo "üõ†Ô∏è  –ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:"
echo "   ‚Ä¢ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è: crontab -l"
echo "   ‚Ä¢ –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è: crontab -e"
echo "   ‚Ä¢ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ª–æ–≥–∏: tail -f /tmp/intshop_*.log"
echo "   ‚Ä¢ –í—Ä—É—á–Ω—É –æ–Ω–æ–≤–∏—Ç–∏ —Ü—ñ–Ω–∏: python3 manage.py update_prices_xls"
echo "   ‚Ä¢ –í—Ä—É—á–Ω—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏: python3 manage.py sync_products"
echo ""

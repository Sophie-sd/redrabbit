#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ—ó —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –∑ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
# –ó–∞–ø—É—Å–∫: ./setup_sync_cron.sh

set -e

PROJECT_DIR="/Users/sofiadmitrenko/Sites/intshop"

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë        –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–á –ó –ö–ê–†–¢–ò–ù–ö–ê–ú–ò                ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# –°—Ç–≤–æ—Ä—é—î–º–æ cron job —Ñ–∞–π–ª
CRON_FILE="/tmp/intshop_sync_cron.txt"

# –ü–æ—Ç–æ—á–Ω—ñ cron jobs
crontab -l > "$CRON_FILE" 2>/dev/null || true

# –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –∑–∞–≤–¥–∞–Ω–Ω—è —è–∫—â–æ —î
grep -v "sync_with_images\|download_all_images\|update_prices" "$CRON_FILE" > "${CRON_FILE}.tmp" 2>/dev/null || true
mv "${CRON_FILE}.tmp" "$CRON_FILE" 2>/dev/null || true

echo "–ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é..."
echo ""

# –î–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ –∑–∞–≤–¥–∞–Ω–Ω—è
echo "" >> "$CRON_FILE"
echo "# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Ç–æ–≤–∞—Ä—ñ–≤ –∑ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏ (–∫–æ–∂–Ω—ñ 2 –≥–æ–¥–∏–Ω–∏)" >> "$CRON_FILE"
echo "0 */2 * * * cd $PROJECT_DIR && source venv/bin/activate && python3 sync_with_images.py >> /tmp/intshop_sync.log 2>&1" >> "$CRON_FILE"

echo "" >> "$CRON_FILE"
echo "# –ü–æ–≤–Ω–∏–π —ñ–º–ø–æ—Ä—Ç —Ç–æ–≤–∞—Ä—ñ–≤ (—â–æ–¥–Ω—è –æ 8 —Ä–∞–Ω–∫—É)" >> "$CRON_FILE"
echo "0 8 * * * cd $PROJECT_DIR && source venv/bin/activate && python3 initial_import.py >> /tmp/intshop_import.log 2>&1" >> "$CRON_FILE"

echo "" >> "$CRON_FILE"
echo "# –ú–∞—Å–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –¥–ª—è —Ç–æ–≤–∞—Ä—ñ–≤ –±–µ–∑ –∑–æ–±—Ä–∞–∂–µ–Ω—å (—â–æ–¥–Ω—è –æ 3 —Ä–∞–Ω–∫—É)" >> "$CRON_FILE"
echo "0 3 * * * cd $PROJECT_DIR && source venv/bin/activate && python3 download_all_images.py >> /tmp/intshop_images.log 2>&1" >> "$CRON_FILE"

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ crontab
crontab "$CRON_FILE"
rm "$CRON_FILE"

echo "‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∞ —É—Å–ø—ñ—à–Ω–æ!"
echo ""
echo "üìã –†–æ–∑–∫–ª–∞–¥ –∑–∞–≤–¥–∞–Ω—å:"
echo "   ‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è (—Ü—ñ–Ω–∏ + –∫–∞—Ä—Ç–∏–Ω–∫–∏): –∫–æ–∂–Ω—ñ 2 –≥–æ–¥–∏–Ω–∏"
echo "   ‚Ä¢ –ü–æ–≤–Ω–∏–π —ñ–º–ø–æ—Ä—Ç: —â–æ–¥–Ω—è –æ 8:00"
echo "   ‚Ä¢ –ú–∞—Å–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏–Ω–æ–∫: —â–æ–¥–Ω—è –æ 3:00"
echo ""
echo "üìÅ –õ–æ–≥–∏:"
echo "   ‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è: /tmp/intshop_sync.log"
echo "   ‚Ä¢ –Ü–º–ø–æ—Ä—Ç: /tmp/intshop_import.log"
echo "   ‚Ä¢ –ö–∞—Ä—Ç–∏–Ω–∫–∏: /tmp/intshop_images.log"
echo ""
echo "üõ†Ô∏è  –ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:"
echo "   ‚Ä¢ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è: crontab -l"
echo "   ‚Ä¢ –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è: crontab -e"
echo "   ‚Ä¢ –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ª–æ–≥–∏: tail -f /tmp/intshop_*.log"
echo ""
